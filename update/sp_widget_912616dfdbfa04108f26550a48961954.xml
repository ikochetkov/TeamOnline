<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function ($scope, spUtil, $rootScope, $timeout, spAriaUtil, spGtd, $window, spModal, $uibModal) {

	window.scope = $scope.data;
	$scope.collapse = function () {
		$rootScope.$emit('sp-navbar-collapse');
	}
	$scope.loadingIndicator = $rootScope.loadingIndicator;
	$scope.cartItemCount = 0;
	$scope.wishlistItemCount = 0;
	$scope.itemAddedTooltipOpen = false;
	$scope.accessibilityEnabled = spAriaUtil.g_accessibility === "true";
	$scope.data.linkEditAllowed = false;

	$scope.$on("$sp.service_catalog.cart.count", function ($evt, count) {
		$scope.cartItemCount = count;
	});
	$scope.$on("$sp.service_catalog.wishlist.count", function ($evt, count) {
		$scope.wishlistItemCount = count;
	});
	var cancelTooltipPromise;
	$scope.$on('sp_loading_indicator', function (e, value) {
		$scope.loadingIndicator = value;
	});
	// PRB1108244: visibleItems array is used to improve keyboard nav
	// in menu, refresh it as needed

	$scope.avatarProfile = {
		userID: $scope.user.sys_id,
		name: $scope.user.name,
		initials: $window.NOW.user_initials
	};

	$scope.createArticle = function () {
		spModal.open({
			title: '',
			widget: 'team_online_article_editor',
			widgetInput: {},
			size: 'md',
			buttons: []
		});
	}

	$scope.allowEdit = function () {
		$scope.data.linkEditAllowed = !$scope.data.linkEditAllowed;
	}

	if ($window.NOW.user_avatar) {
		$scope.avatarProfile.userImage = $window.NOW.user_avatar;
	}

	$scope.openPopUp = function () {
		var url = "$chat_support.do?queueID=" + $scope.data.connect_support_queue_id;
		var popup = window.open(url, "popup", "width=900, height=600");
	};

	$scope.openLogin = function () {
		$scope.modalInstance = $uibModal.open({
			templateUrl: 'modalLogin',
			scope: $scope
		});
	};

	var xsScreenSize = isXSScreenSize();
	$scope.showXSAvatar = isXSScreenSize();
	$scope.showAvatar = !isXSScreenSize();

	$scope.isAgentChatConfigured = g_has_agent_chat_config;

	angular.element($window).on('resize', function () {
		if (xsScreenSize !== isXSScreenSize() && (!$scope.showXSAvatar || !$scope.showAvatar)) {
			$scope.showXSAvatar = true;
			$scope.showAvatar = true;
		}
	});

	spUtil.get("team_online_article_editor").then(function (response) {
		$scope.newArticle = response;
	});

	function isXSScreenSize() {
		return $window.matchMedia('(max-width: 767px)').matches;
	}

	$rootScope.$on('sp.avatar_changed', function (evt, obj) {
		$scope.userID = "";
		$scope.newAvatarId = obj.newAvatarId;
		$timeout(function () {
			$scope.userID = $scope.user.sys_id;
			$(".sub-avatar").css("background-image", 'url("' + $scope.newAvatarId + '.iix?t=small")');
		});
	});

	$scope.$watch('data.menu.items', function () {
		$scope.visibleItems = [];
		if ($scope.data.menu.items) {
			for (var i in $scope.data.menu.items) {
				var item = $scope.data.menu.items[i];
				if (item.items || (item.scriptedItems && item.scriptedItems.count != 0))
					$scope.visibleItems.push(item);
			}
		}
	}, true);
	$scope.$on('sp-menu-update-tours', function (event, tours) {
		$scope.data.showTours = $scope.data.showTours && !spUtil.isMobile();
		if ($scope.data.showTours === false) return;
		var guidedToursLabel = 'Guided Tours';
		$scope.data.guidedTours = {
			label: guidedToursLabel,
			collection: []
		};
		if (tours.length > 0) {
			$scope.data.guidedTours.collection = tours.map(function (t) {
				return {
					title: t.name,
					id: t.id,
					clicked: function () {
						spGtd.launch(t.id);
					}
				};
			});
		}
	});
	// Get list of record watchers
	var record_watchers = [];
	if ($scope.data.menu.items) {
		for (var i in $scope.data.menu.items) {
			var item = $scope.data.menu.items[i];
			if (item.type == 'scripted') {
				if (item.scriptedItems.record_watchers)
					record_watchers = record_watchers.concat(item.scriptedItems.record_watchers);
			}
			if (item.type == 'filtered') {
				record_watchers.push({ 'table': item.table, 'filter': item.filter });
			}
		}
	}
	// Init record watchers
	for (var y in record_watchers) {
		var watcher = record_watchers[y];
		spUtil.recordWatch($scope, watcher.table, watcher.filter);
	}
	$rootScope.$broadcast('sp-header-loaded');


	var flatFields = [];
	if ($scope.data.canEdit)
		angular.forEach($scope.data.linkData.form._fields, function (field) {
			flatFields.push(field);
		});


	$scope.getGlideForm = function () {
		var uiMessageHandler = function (g_form, type, message) {
			switch (type) {
				case 'addInfoMessage':
					spUtil.addInfoMessage(message);
					break;
				case 'addErrorMessage':
					spUtil.addErrorMessage(message);
					break;
				case 'clearMessages':
					break;
				default:
			}
		};

		var g_form = glideFormFactory.create($scope, $scope.data.linkData.form.table, $scope.data.linkData.form.sys_id, flatFields, null, { uiMessageHandler: uiMessageHandler });
		return g_form;
	}


	$scope.openLinkEditor = function (item, operation, parent) {
		$scope.data.link = {};
		$scope.data.link.sys_id = item.sys_id;
		$scope.data.link.operation = operation;

		if (parent) {
			$scope.data.link.parent = {
				sys_id: parent.sys_id,
				displayValue: parent.label
			}

		}

		spUtil.update($scope).then(function () {
			$scope.showModal();
			$scope.data.link = {};
		})

	};
	$scope.showModal = function () {
		$scope.modalInstance = $uibModal.open({
			animation: true,
			templateUrl: 'teamonlineQuickLinkEditor',
			size: 'lg',
			backdrop: false,
			scope: $scope
		});
	}
	$scope.closeEditor = function () {
		$scope.data.linkData.sys_id = '';
		$scope.modalInstance.close();
	};
	$scope.openUrl = function (url) {
		window.location = url;
	}
	$scope.saveRecord = function () {
		var x = {};
		x.method = "save";
		x.table = $scope.data.linkData.table;
		x.sys_id = $scope.data.linkData.sys_id;
		x._fields = $scope.data.linkData.form._fields;

		if (!x._fields.label.value || !x._fields.url.value) {
			spUtil.addErrorMessage("Please fill Label and Url");
			return;
		}
		if (!validateUrl(x._fields.url.value)) {
			spUtil.addErrorMessage("Please provide correct URL in format: https://sitename.domain");
			return
		}

		spUtil.get($scope, x).then(function (response) {
			if ($scope.modalInstance) {
				$scope.modalInstance.close();
			}
			spUtil.update($scope)
		});
	}

	$scope.deleteRecord = function (item, type) {
		spModal.open({
			title: 'Delete this ' + type + '?',
			message: type + ' will be deleted from system permanently',
			buttons: [
				{ label: '${No}', cancel: true },
				{ label: '${Yes}', primary: true }
			]
		}).then(function () {
			$scope.data.linkData.operation = 'delete';
			$scope.data.linkData.sys_id = item.sys_id;
			spUtil.update($scope).then(function () {
				spUtil.addInfoMessage(type + ' was deleted');
				spUtil.update($scope)
			});
		});
	}
	function validateUrl(url) {
		var regex = new RegExp(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/);
		return regex.test(url)
	}
	var spWindow = getSpWindow();
	var header = getHeader();
	var head = getHead()
	var sticky = header.offsetTop;
	spWindow.addEventListener('scroll', function (e) {
		onScroll();
	});



	// Add the sticky class to the header when you reach its scroll position. Remove "sticky" when you leave the scroll position
	function onScroll() {

		if (spWindow.scrollTop > sticky) {
			header.classList.add("header-fixed");
			head.classList.add("margin-bottom")
		} else {
			header.classList.remove("header-fixed");
			head.classList.remove("margin-bottom")
		}
	}
	function getHeader() {
		return document.getElementsByClassName("menu-container")[0];
	}
	function getSpWindow() {
		return document.getElementsByClassName('sp-scroll')[0];
	}
	function getHead() {
		return document.getElementsByClassName('navbar-inverse')[0];
	}
}]]></client_script>
        <controller_as>c</controller_as>
        <css>$blue: #0069c8;
$lightblue: #0071ce;
.header-loader {
  float: left;
  width: 24px;
  position: relative;
  top: 24px;
}
.color-white {
  color: white;
}
.color-white:hover {
  color: rgba(255, 255, 255, 0.6);
}
.semi-transparent {
  color: rgba(255, 255, 255, 0.6);
}
a.semi-transparent:hover {
  color: white;
}
.avatar {
  float: right;
}
.header__nav .megamenu {
  position: static;
}
.header__nav li.has-children {
  padding-right: 3.3rem;
}
.profile-dropdown {
  background-color: $lightblue;
  top: 39px;
  z-index: 500;
  li {
    display: block;
    a {
      line-height: inherit;
    }
  }
}

.header__nav li:hover &gt; a,
.header__nav li:focus &gt; a {
  color: #ffffff;
}

.header__nav li:hover li,
.header__nav li:focus li {
  background: transparent;
}

.profile-menu-item {
  position: relative;
}
.header__nav &gt; li &gt; a {
  line-height: 39px;
}
.header-menu-item {
  font-size: 1.2em;
  &amp;.dropdown {
    position: static;
  }
}
.megamenu {
  position: static;
}
.megamenu-bg {
  background-color: $lightblue;
  border-radius: 0px;
  max-height: calc(100vh - 132px);
  overflow: auto;
  &amp;::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    background-color: $lightblue;
  }
  &amp;::-webkit-scrollbar {
    width: 12px;
    background-color: $lightblue;
  }
  &amp;::-webkit-scrollbar-thumb {
    border-radius: 10px;
    background-color: rgba(255, 255, 255, 0.884);
  }
}
.megamenu-container {
  position: absolute;
  top: auto;
  left: 0;
  padding-top: 20px;
  min-width: 100%;
  border: none;
  z-index: 500;
  color: white;
  visibility: hidden;
  opacity: 0;
  transform: translate3d(0, -15px, 0);
  transition: visibility 0s 200ms, opacity 200ms ease-in-out, transform 200ms ease-in-out;

  ul li {
    position: relative;
  }
}
.megamenu-list,
.megamenu-list-item {
  position: relative;
}

.megamenu-subcategory {
  text-decoration: none;
}
.subheading-list-item {
  margin-left: 5px;
}
.megamenu-subcategory:hover {
  color: white;
}
.three-column-layout {
  -webkit-column-width: 30%;
  -moz-column-width: 30%;
  column-width: 30%;
  -webkit-column-count: 3;
  -moz-column-count: 3;
  column-count: 3;
  -webkit-column-gap: 30px;
  -moz-column-gap: 30px;
  column-gap: 30px;
  text-align: left;
}
.column-fill-auto {
  column-fill: auto;
}
.column-fill-balance {
  column-fill: balance;
}
.i-b {
  display: inline-block;
}
.btn-add-subcategory {
  border: none;
  background: none;
  color: white;
}
.btn-add-subcategory:hover {
  border: none;
  background: none;
  color: gray;
}
.megamenu__category {
  display: inline;
}

.dropdown .dropdown-menu {
  opacity: 0;
  display: none;
}
.dropdown-menu {
  a:hover {
    background-color: $blue;
  }
}
.dropdown.open .dropdown-menu {
  display: block;
  -webkit-transform: translate3d(0, 15px, 0);
  -ms-transform: translate3d(0, 15px, 0);
  transform: translate3d(0, 15px, 0);
  -webkit-transition: all 0.5s ease-in-out;
  transition: all 0.5s ease-in-out;

  opacity: 1;
}

.megamenu {
  &amp;:hover &gt; .megamenu-container {
    visibility: visible;
    opacity: 1;
    transform: translate3d(0, 0px, 0);
    transition: 300ms ease-in-out;
  }
}
.btn-lock {
  &amp;:hover {
    color: white;
  }
}
</css>
        <data_table>sp_instance_menu</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list>title</field_list>
        <has_preview>false</has_preview>
        <id>team_online_header_menu</id>
        <internal>false</internal>
        <link/>
        <name>Team Online Header Menu</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function () {
	// build menus
	data.canEdit = gs.getUser().isMemberOf(gs.getProperty("x_aaro2_teamonline.teamonline_administration_group")) || gs.hasRole("admin");
	data.isLoggedIn = gs.getSession().isLoggedIn();

	data.login_page = $sp.getValue('login_page');
	data.profileBtnMsg = gs.getMessage("User options");

	data.menuid = $sp.getValue('sys_id');
	var menu_id = $sp.getValue('sys_id'); // instance sys_id
	var gr = new GlideRecord('sp_instance_menu');
	gr.get(menu_id);

	data.menu = {};
	data.menu.items = $sp.getMenuItems(menu_id);

	// Show tours only if gtd's sp sys property is set
	data.showTours = (gs.getProperty('com.snc.guided_tours.sp.enable') === 'true') && data.isLoggedIn;
	var catalogArr = ($sp.getCatalogs().value + "").split(",");
	data.loginWidget = $sp.getWidgetFromInstance('login-modal');
	catalogArr.forEach(function (catalog) {
		data.showWishlist = data.showWishlist || new sn_sc.Catalog(catalog).isWishlistEnabled();
	});
	if (data.canEdit) {
		var linkFields = {
			label: {
				readonly: false,
				value: '',
				displayValue: '',
				mandatory: true
			},
			url: {
				readonly: false,
				value: '',
				displayValue: '',
				mandatory: true
			},
			glyph: {
				readonly: false,
				value: '',
				displayValue: '',
				mandatory: false
			},
			order: {
				readonly: false,
				value: '',
				displayValue: '',
				mandatory: false
			},
			type: {
				readonly: true,
				value: 'url',
				displayValue: 'Url',
				mandatory: false
			},
			sp_rectangle_menu_item: {
				readonly: false,
				value: '',
				displayValue: '',
				mandatory: true
			}
		}
		data.linkData = {};
		data.linkData.table = 'sp_rectangle_menu_item';
		data.linkData.sys_id = '-1';
		data.linkData.view = 'teamonlineportaledit';
		data.linkData.operation = 'Create';
		data.linkData.query = '';
		data.linkData.wasInput = !!input;
		if (input && input.link) {
			data.linkData.sys_id = input.link.sys_id ? input.link.sys_id : '-1';
			data.linkData.operation = input.link.operation || 'Create';
			data.linkData.parent = input.link.parent;
		}
		if (input && input._fields) {
			saveFormData(input.table, input.sys_id, input._fields, linkFields);
		}
		if (input && input.linkData && input.linkData.operation == 'delete') {
			data.deleteInfo = 'input.linkData.sys_id';
			var menuItemGr = new GlideRecord(data.linkData.table);
			menuItemGr.get(input.linkData.sys_id);
			menuItemGr.deleteRecord();
		}
		data.linkData.form = $sp.getForm(data.linkData.table, data.linkData.sys_id, data.linkData.query, data.linkData.view);
		var fields = data.linkData.form._fields;

		if (data.linkData.parent) {
			linkFields.sp_rectangle_menu_item.value = data.linkData.parent.sys_id;
			linkFields.sp_rectangle_menu_item.displayValue = data.linkData.parent.displayValue;
			linkFields.sp_rectangle_menu_item.readonly = true;
		}

		data.linkData.form._fields = prepareFormFields(fields, linkFields);
	}

})();

function saveFormData(table, sys_id, fields, fieldsToSave) {
	var recordGr = new GlideRecord(table);
	var isInsert = !recordGr.get(sys_id);
	if (isInsert) recordGr.initialize();
	for (var key in fieldsToSave) {
		recordGr[key] = fields[key].value;
	}
	if (isInsert) recordGr.insert();
	else recordGr.update();
}

function prepareFormFields(fields, props) {

	if (fields.sp_rectangle_menu_item.displayValue === 'Quick Links')
		props.sp_rectangle_menu_item.readonly = true;

	for (var key in props) {
		for (var prop in props[key]) {
			fields[key][prop] = props[key][prop] !== '' ? props[key][prop] : fields[key][prop];
		}
		fields[key].sys_readonly = false;

	}

	return fields;
}]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>xxabunko</sys_created_by>
        <sys_created_on>2020-02-11 17:07:22</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>912616dfdbfa04108f26550a48961954</sys_id>
        <sys_mod_count>314</sys_mod_count>
        <sys_name>Team Online Header Menu</sys_name>
        <sys_package display_value="TEAMonline" source="x_aaro2_teamonline">a2dfc25fdb7244105f65ba03e29619fa</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="TEAMonline">a2dfc25fdb7244105f65ba03e29619fa</sys_scope>
        <sys_update_name>sp_widget_912616dfdbfa04108f26550a48961954</sys_update_name>
        <sys_updated_by>andrey.mironyuk</sys_updated_by>
        <sys_updated_on>2020-06-17 12:09:38</sys_updated_on>
        <template><![CDATA[<div class="menu-container">
  <nav class="header__nav-wrap" style="margin-top: 0">
    <ul ng-if="user.logged_in" class="header__nav" aria-label="${Header menu}" role="menubar">
      <div class="header-loader" ng-class="{'invisible': !loadingIndicator}">
        <div class="hidden-xs sp-loading-indicator la-sm">
          <div></div>
          <div></div>
          <div></div>
        </div>
      </div>

      <li ng-repeat="item in visibleItems" ng-class="{dropdown: item.items.length > 0, 'header-menu-item': true}"
        ng-include="'teamOnlineMainMenu'" role="presentation"></li>
      <li ng-if="data.canEdit">
        <sp-widget widget="newArticle"></sp-widget>
      </li>
      <li ng-if="showAvatar" class="hidden-xs dropdown has-children avatar profile-menu-item" role="presentation">
        <a href class="toggle-dropdown" data-toggle="dropdown" aria-expanded="false" title="{{::data.profileBtnMsg}}"
          aria-label="{{::data.profileBtnMsg}}: {{::user.name}}" id="profile-dropdown" role="menuitem"
          aria-haspopup="true">
          <span aria-hidden="true">
            <sn-avatar class="avatar-small-medium" primary="avatarProfile" /></span>
          <span class="visible-lg-inline">{{::user.name}}</span>
        </a>
        <ul class="dropdown-menu sub-menu profile-dropdown" role="menu" aria-label="{{::data.profileBtnMsg}}">
          <li role="presentation"><a tabindex="-1" ng-href="?id=user_profile&sys_id={{::user.sys_id}}"
              role="menuitem">${Profile}</a></li>
          <li ng-if="::!(isViewNative || isViewNativeTablet)" role="presentation"><a tabindex="-1"
              href="{{::portal.logoutUrl}}" role="menuitem">${Logout}</a></li>
        </ul>
      </li>
      <li ng-if="showXSAvatar" class="visible-xs-block" role="presentation"><a role="menuitem"
          ng-href="?id=user_profile&sys_id={{::user.sys_id}}" ng-click="collapse()">
          <span class="navbar-avatar">
            <sn-avatar class="avatar-small-medium" primary="avatarProfile" /></span>{{::user.name}}</a>
      </li>
      <li ng-if="::!(isViewNative || isViewNativeTablet)" class="visible-xs-block" role="presentation"><a
          role="menuitem" ng-href="{{::portal.logoutUrl}}" ng-click="collapse()">${Logout}</a></li>
    </ul>

    <ul ng-if="(!user.logged_in && page.id != portal.login_page_dv && !data.hasLogin)" class="nav navbar-nav"
      role="presentation">
      <li role="presentation"><a href ng-click="::openLogin()">${Login}</a></li>
    </ul>
  </nav>
</div>]]></template>
    </sp_widget>
</record_update>
